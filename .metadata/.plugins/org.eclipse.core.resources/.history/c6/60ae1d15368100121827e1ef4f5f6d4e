package com.valleskeyp.tubehub;

import java.util.ArrayList;

import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

import android.os.Bundle;
import android.app.Activity;
import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.Intent;
import android.content.IntentFilter;
import android.content.SharedPreferences;
import android.content.SharedPreferences.Editor;
import android.util.Log;
import android.view.Menu;
import android.view.MenuItem;
import android.view.View;
import android.widget.ArrayAdapter;
import android.widget.Button;
import android.widget.ImageButton;
import android.widget.ListView;
import android.widget.PopupMenu;


public class MainActivity extends Activity {
	private ResponseReceiver receiver;
	Context _context;
	String _access_token;
	String _refresh_token;
	ListView _listView;
	SharedPreferences _pref;
	
    @Override
    public void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.main_list_view);
        _context = this;
        
        
        _pref = getApplicationContext().getSharedPreferences("Login", 0);
        _access_token = _pref.getString("access_token", null);
        _refresh_token = _pref.getString("refresh_token", null);
Log.i("FIRST_TOKEN", _access_token);
        _listView = (ListView) this.findViewById(R.id.list_content);
        Button submitButton = (Button) this.findViewById(R.id.temp_button);
        ImageButton searchButton = (ImageButton) this.findViewById(R.id.search);
        
		submitButton.setOnClickListener(new View.OnClickListener() {
			
			@Override
			public void onClick(View v) {
				Intent i = new Intent(_context, EditActivity.class);
				
				startActivityForResult(i, 1);
				
			}
		});
		
		searchButton.setOnClickListener(new View.OnClickListener() {
			
			@Override
			public void onClick(View v) {
				
			}
		});
		
		IntentFilter filter = new IntentFilter(ResponseReceiver.ACTION_RESPONSE);
        filter.addCategory(Intent.CATEGORY_DEFAULT);
        receiver = new ResponseReceiver();
        registerReceiver(receiver, filter);
        
		Intent msgIntent = new Intent(this, YouTubeService.class);
		msgIntent.putExtra(YouTubeService.PARAM_IN_MSG, _refresh_token);
		startService(msgIntent);
    }
    
    
    
    // Logout Functionality
    
    public void dropdownMenuClick(View button) {
        PopupMenu dropdown = new PopupMenu(_context, button);
        dropdown.getMenuInflater().inflate(R.menu.dropdown, dropdown.getMenu());

        dropdown.setOnMenuItemClickListener(new PopupMenu.OnMenuItemClickListener() {
            @Override
        	public boolean onMenuItemClick(MenuItem item) {
            	OpenDialog();
                return true;
            }

			private void OpenDialog() {
				MyDialogFragment myDialogFragment = MyDialogFragment.newInstance();
			    myDialogFragment.show(getFragmentManager(), "myDialogFragment");
			}
        });
        dropdown.show();
    }
    
    public void okClicked() {
    	  // clear preferences, move to login, clear backstack
    	SharedPreferences pref = getApplicationContext().getSharedPreferences("Login", 0);
    	Editor editor = pref.edit();
    	editor.clear();
    	editor.commit();
    	
    	setResult(999);
    	startActivity(new Intent(this, Login_Activity.class));
    	finish();
    }
    
    @Override
    public boolean onCreateOptionsMenu(Menu menu) {
        getMenuInflater().inflate(R.menu.activity_main, menu);
        return true;
    }
    
    public class ResponseReceiver extends BroadcastReceiver {
    	public static final String ACTION_RESPONSE = "com.valleskeyp.intent.action.ACTION_RESPONSE";
    	
		@Override
		public void onReceive(Context context, Intent intent) {
			String data = intent.getStringExtra(YouTubeService.PARAM_OUT_MSG);
			_access_token = intent.getStringExtra("access_Token");
			Editor editor = _pref.edit();
			editor.putString("access_token", _access_token);
			editor.commit();
			
			Log.i("TOKEN", _access_token);
			ArrayList<String> videoListView = new ArrayList<String>();
		    try {
				JSONObject json = new JSONObject(data);
				JSONArray videos = json.getJSONArray("items");
				for (int i = 0; i < videos.length(); i++) {
					JSONObject videoJSON = videos.getJSONObject(i);
//					Log.i("VIDEO_WHOLE_INFO", videoJSON.toString());
//					Log.i("VIDEO_NAME", videoJSON.getJSONObject("snippet").getString("title"));
//					Log.i("VIDEO_NAME", videoJSON.getJSONObject("snippet").getJSONObject("resourceId").getString("videoId"));
					
					
					videoListView.add(videoJSON.getJSONObject("snippet").getString("title"));
				}
				ArrayAdapter<String> adapter = new ArrayAdapter<String>(_context, android.R.layout.simple_list_item_1, android.R.id.text1, videoListView);
		        _listView.setAdapter(adapter);
				
				
			} catch (JSONException e) {
				e.printStackTrace();
			}
		    
		}
    	
    }
    
    
    @Override
    protected void onPause() {
    	
    	super.onPause();
    }
}
