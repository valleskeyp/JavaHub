package com.valleskeyp.androidproject1;

import org.json.JSONException;
import org.json.JSONObject;

import com.valleskeyp.lib.WebStuff;

import android.app.Fragment;
import android.content.Context;
import android.content.Intent;
import android.graphics.Color;
import android.net.Uri;
import android.os.Bundle;
import android.text.method.ScrollingMovementMethod;
import android.util.Log;
import android.view.Gravity;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.view.inputmethod.InputMethodManager;
import android.widget.AdapterView;
import android.widget.ArrayAdapter;
import android.widget.Button;
import android.widget.EditText;
import android.widget.ImageButton;
import android.widget.LinearLayout;
import android.widget.Spinner;
import android.widget.TextView;
import android.widget.Toast;
import android.widget.AdapterView.OnItemSelectedListener;

public class MainFragment extends Fragment {
	
	public interface MainListener {
		public void onRecentSelect(String recentTitle);
		public void onSearchGo(String searchedTitle);
		public void openWebIntent();
	}
	@Override
	public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
		
		super.onCreateView(inflater, container, savedInstanceState);
		
		LinearLayout view = (LinearLayout) inflater.inflate(R.layout.main_view,	container, false);
		
		//Get elements from XML Layouts
        Button fieldButton = (Button) getActivity().findViewById(R.id.edit_button);
        TextView _textField = (TextView) getActivity().findViewById(R.id.text_view);
        Spinner _recentsList = (Spinner) getActivity().findViewById(R.id.recents_list);
        ImageButton _imageButton = (ImageButton) getActivity().findViewById(R.id.imageButton1);
        _imageButton.setBackgroundColor(Color.BLACK);
        
        //setup scrolling on textview
        _textField.setMovementMethod(new ScrollingMovementMethod());
        
        //setup recents list
        ArrayAdapter<String> listAdapter = new ArrayAdapter<String>(_context, android.R.layout.simple_spinner_item, _recentTitle);
        listAdapter.setDropDownViewResource(android.R.layout.simple_dropdown_item_1line);
        _recentsList.setAdapter(listAdapter);
        
		//setup recents listener
        _recentsList.setOnItemSelectedListener(new OnItemSelectedListener() {
        	
        	@Override
        	public void onItemSelected(AdapterView<?> parent, View v, int pos, long id) {
        		Log.i("RECENT SELECTED", "POSITION: " + pos + "\r\nID: " + id);
        		String str = parent.getItemAtPosition(pos).toString();
        		
        		//Gets the selected title from memory and displays it
        		if (!(pos == 0)) {
        			String movieString = _recent.get(str);
        			try {
        				JSONObject json = new JSONObject(movieString);
        				_movieTitle = json.getString("title");
        				_textField.setText("\r\nTitle: " + json.getString("title") + "\r\n\r\nRating: " + json.getString("mpaa_rating") + "\r\n\r\nCritics Consensus: " + json.getString("critics_consensus") + "\r\n\r\nSynopsis: " + json.getString("synopsis"));
        				} catch (JSONException e) {
        					Log.e("JSON", "JSON OBJECT EXCEPTION");
        			}
				}
        	}
        	
        	@Override
        	public void onNothingSelected(AdapterView<?> parent) {
        		Log.i("RECENT SELECTED", "NO SELECTION");
        	}
		});
        
        //Go button listener for search bar
        fieldButton.setOnClickListener(new View.OnClickListener() {
			
			@Override
			public void onClick(View v) {
				//gets edittext tag from button reference
				EditText field = (EditText) getActivity().findViewById(R.id.edit_field);
				//hide keyboard after button press
				InputMethodManager imm = (InputMethodManager) getActivity().getSystemService(Context.INPUT_METHOD_SERVICE);
				imm.hideSoftInputFromWindow(field.getWindowToken(), 0);
				_movieTitle = field.getText().toString().trim();
				//check network access first, then begin process of getting api data with field string
				_connected = WebStuff.getConnectionStatus(_context);
				if (_connected) {
					if (_movieTitle.equals("")) {
						return;
					}
					Toast toast = Toast.makeText(_context, "Attempting to retrieve movie data", Toast.LENGTH_LONG);
					toast.setGravity(Gravity.TOP, 0, 70);
					toast.show();
					//have connection, now send API request
					getMovie(field.getText().toString().trim().replace(" ", "+"));
				} else {
					//no connection.
					_textField.setText("Sorry, unable to search without a working connection.\n\rPlease connect and try again.");
				}
			}
		});
        
        //implicit intent imageButton listener
        _imageButton.setOnClickListener(new View.OnClickListener() {
			
			@Override
			public void onClick(View v) {
				//open movie website with implicit intent
				if (!(_movieTitle.equals(""))) {
					String str = _movieTitle.replace("The", "").trim().replace(" ", "_");
					Uri uri = Uri.parse("http://www.rottentomatoes.com/mobile/m/" + str + "/");
					Intent intent = new Intent(Intent.ACTION_VIEW, uri);
					startActivity(intent);
				}
			}
		});


		
		return view;
	};
}
